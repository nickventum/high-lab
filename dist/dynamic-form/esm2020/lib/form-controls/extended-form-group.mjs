import { FormGroup } from '@angular/forms';
import { Subject } from 'rxjs';
import { filter, map, startWith } from 'rxjs/operators';
import { CommonHelper, RandomHelper } from '../helpers';
export class ExtendedFormGroup extends FormGroup {
    constructor() {
        super(...arguments);
        this.supposeControls = new Map();
        this.id = RandomHelper.NumId;
        this.defaultValidationMessages = {};
        this.defaultValuePatched = false;
        this.childrenControls = [];
        this.error = this.statusChanges.pipe(startWith(false), map(() => CommonHelper.instantError(this, true)));
        this.errorObject = this.statusChanges.pipe(startWith(false), map(() => CommonHelper.instantError(this, false)));
    }
    get canShowError() {
        return this.invalid && (this.touched || this.dirty);
    }
    get isChangedByUser() {
        if (this.fieldConfig && typeof this.fieldConfig.checkChanges === 'function') {
            return this.fieldConfig.checkChanges(this.value, this.defaultValuePatched);
        }
        for (const control of Object.values(this.controls)) {
            if (control.isChangedByUser) {
                return true;
            }
        }
        return false;
    }
    get(path) {
        return super.get(path);
    }
    patchValue(value, options = {}) {
        if (value == null /* both `null` and `undefined` */) {
            return;
        }
        if (options.useAsDefault) {
            this.defaultValuePatched = true;
        }
        Object.keys(value).forEach(name => {
            if (this.controls[name]) {
                this.controls[name].patchValue(value[name], { ...options, onlySelf: true });
            }
        });
        this.updateValueAndValidity(options);
        this.lastPatchedValue = value;
    }
    validate(scrollToError = true) {
        this.markAllAsTouched();
        this.updateValueAndValidity({ onlySelf: true });
        if (scrollToError && this.invalid) {
            this.scrollToError();
        }
        return this.valid;
    }
    resetDefaultValue() {
        this.defaultValuePatched = false;
        Object.values(this.controls).forEach(control => control.resetDefaultValue());
    }
    resetToDefaultValue(options = {}) {
        Object.values(this.controls).forEach(control => control.resetToDefaultValue({ ...options, onlySelf: true }));
        this.updateValueAndValidity();
    }
    scrollToError() {
        const invalidControl = CommonHelper.getFirstInvalidControl(this);
        if (invalidControl) {
            invalidControl.htmlInstance.scrollIntoView({ behavior: 'smooth' });
        }
    }
    updateChildrenControls() {
        this.childrenControls = Object.values(this.controls);
        this.childrenControls.sort((a, b) => {
            if (a.fieldConfig.internalOrder < b.fieldConfig.internalOrder) {
                return -1;
            }
            else if (a.fieldConfig.internalOrder > b.fieldConfig.internalOrder) {
                return 1;
            }
            return 0;
        });
    }
    getControl(path) {
        const pathStr = this.pathFromRoot + path.join('.');
        const root = this.root;
        if (!root.supposeControls.has(pathStr)) {
            root.supposeControls.set(pathStr, new Subject());
        }
        const subject = root.supposeControls.get(pathStr);
        return subject.pipe(filter(v => !!v));
    }
    getRawValue(params = { ignoredFields: false }) {
        return this.childrenControls.reduce((acc, control) => {
            if (!control.fieldConfig.ignore || params.ignoredFields) {
                acc[control.fieldConfig.key] = control.getRawValue(params);
            }
            return acc;
        }, {});
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXh0ZW5kZWQtZm9ybS1ncm91cC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2R5bmFtaWMtZm9ybS9zcmMvbGliL2Zvcm0tY29udHJvbHMvZXh0ZW5kZWQtZm9ybS1ncm91cC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMzQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUd4RCxPQUFPLEVBQUUsWUFBWSxFQUFFLFlBQVksRUFBRSxNQUFNLFlBQVksQ0FBQztBQUt4RCxNQUFNLE9BQU8saUJBQWtCLFNBQVEsU0FBUztJQUFoRDs7UUFDa0Isb0JBQWUsR0FBRyxJQUFJLEdBQUcsRUFBcUMsQ0FBQztRQUMvRCxPQUFFLEdBQUcsWUFBWSxDQUFDLEtBQUssQ0FBQztRQUVqQyw4QkFBeUIsR0FBdUIsRUFBRSxDQUFDO1FBSW5ELHdCQUFtQixHQUFHLEtBQUssQ0FBQztRQUU1QixxQkFBZ0IsR0FBNEIsRUFBRSxDQUFDO1FBRS9DLFVBQUssR0FBOEIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQy9ELFNBQVMsQ0FBQyxLQUFLLENBQUMsRUFDaEIsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQ2pELENBQUM7UUFFSyxnQkFBVyxHQUFtQyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FDMUUsU0FBUyxDQUFDLEtBQUssQ0FBQyxFQUNoQixHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FDbEQsQ0FBQztJQTRHSixDQUFDO0lB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QyxDQUFDLENBQ2pCLENBQUM7SUFDSixDQUFDO0lBRU0sV0FBVyxDQUFDLE1BQU0sR0FBRyxFQUFFLGFBQWEsRUFBRSxLQUFLLEVBQUU7UUFDbEQsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLE9BQU8sRUFBRSxFQUFFO1lBQ25ELElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLE1BQU0sSUFBSSxNQUFNLENBQUMsYUFBYSxFQUFFO2dCQUN0RCxHQUFXLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsR0FBSSxPQUFlLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2FBQzlFO1lBQ0QsT0FBTyxHQUFHLENBQUM7UUFDYixDQUFDLEVBQUUsRUFBRSxDQUFRLENBQUM7SUFDaEIsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRm9ybUdyb3VwIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGZpbHRlciwgbWFwLCBzdGFydFdpdGggfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEdyb3VwRmllbGQgfSBmcm9tICcuLi9iYXNlLmZpZWxkJztcclxuaW1wb3J0IHsgVmFsaWRhdGlvbk1lc3NhZ2VzIH0gZnJvbSAnLi4vZHluYW1pYy1mb3JtLmNvbmZpZyc7XHJcbmltcG9ydCB7IENvbW1vbkhlbHBlciwgUmFuZG9tSGVscGVyIH0gZnJvbSAnLi4vaGVscGVycyc7XHJcbmltcG9ydCB7IEVycm9yT2JqZWN0IH0gZnJvbSAnLi4vaW50ZXJmYWNlcyc7XHJcbmltcG9ydCB7IEV4dGVuZGVkQ29udHJvbHMgfSBmcm9tICcuL2luZGV4JztcclxuXHJcblxyXG5leHBvcnQgY2xhc3MgRXh0ZW5kZWRGb3JtR3JvdXAgZXh0ZW5kcyBGb3JtR3JvdXAge1xyXG4gIHB1YmxpYyByZWFkb25seSBzdXBwb3NlQ29udHJvbHMgPSBuZXcgTWFwPHN0cmluZywgU3ViamVjdDxFeHRlbmRlZENvbnRyb2xzPj4oKTtcclxuICBwdWJsaWMgcmVhZG9ubHkgaWQgPSBSYW5kb21IZWxwZXIuTnVtSWQ7XHJcbiAgcHVibGljIHBhdGhGcm9tUm9vdCE6IHN0cmluZztcclxuICBwdWJsaWMgZGVmYXVsdFZhbGlkYXRpb25NZXNzYWdlczogVmFsaWRhdGlvbk1lc3NhZ2VzID0ge307XHJcbiAgcHVibGljIGNvbnRyb2xzITogeyBba2V5OiBzdHJpbmddOiBFeHRlbmRlZENvbnRyb2xzIH07XHJcbiAgcHVibGljIGZpZWxkQ29uZmlnITogR3JvdXBGaWVsZDtcclxuICBwdWJsaWMgbGFzdFBhdGNoZWRWYWx1ZTogeyBba2V5OiBzdHJpbmddOiBhbnkgfSB8IHVuZGVmaW5lZDtcclxuICBwdWJsaWMgZGVmYXVsdFZhbHVlUGF0Y2hlZCA9IGZhbHNlO1xyXG4gIHB1YmxpYyBodG1sSW5zdGFuY2UhOiBIVE1MRWxlbWVudDtcclxuICBwdWJsaWMgY2hpbGRyZW5Db250cm9sczogQXJyYXk8RXh0ZW5kZWRDb250cm9scz4gPSBbXTtcclxuXHJcbiAgcHVibGljIGVycm9yOiBPYnNlcnZhYmxlPHN0cmluZyB8IG51bGw+ID0gdGhpcy5zdGF0dXNDaGFuZ2VzLnBpcGUoXHJcbiAgICBzdGFydFdpdGgoZmFsc2UpLFxyXG4gICAgbWFwKCgpID0+IENvbW1vbkhlbHBlci5pbnN0YW50RXJyb3IodGhpcywgdHJ1ZSkpXHJcbiAgKTtcclxuXHJcbiAgcHVibGljIGVycm9yT2JqZWN0OiBPYnNlcnZhYmxlPEVycm9yT2JqZWN0IHwgbnVsbD4gPSB0aGlzLnN0YXR1c0NoYW5nZXMucGlwZShcclxuICAgIHN0YXJ0V2l0aChmYWxzZSksXHJcbiAgICBtYXAoKCkgPT4gQ29tbW9uSGVscGVyLmluc3RhbnRFcnJvcih0aGlzLCBmYWxzZSkpXHJcbiAgKTtcclxuXHJcbiAgcHVibGljIGdldCBjYW5TaG93RXJyb3IoKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gdGhpcy5pbnZhbGlkICYmICh0aGlzLnRvdWNoZWQgfHwgdGhpcy5kaXJ0eSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0IGlzQ2hhbmdlZEJ5VXNlcigpOiBib29sZWFuIHtcclxuICAgIGlmICh0aGlzLmZpZWxkQ29uZmlnICYmIHR5cGVvZiB0aGlzLmZpZWxkQ29uZmlnLmNoZWNrQ2hhbmdlcyA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICByZXR1cm4gdGhpcy5maWVsZENvbmZpZy5jaGVja0NoYW5nZXModGhpcy52YWx1ZSwgdGhpcy5kZWZhdWx0VmFsdWVQYXRjaGVkKTtcclxuICAgIH1cclxuXHJcbiAgICBmb3IgKGNvbnN0IGNvbnRyb2wgb2YgT2JqZWN0LnZhbHVlcyh0aGlzLmNvbnRyb2xzKSkge1xyXG4gICAgICBpZiAoY29udHJvbC5pc0NoYW5nZWRCeVVzZXIpIHtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBnZXQocGF0aDogQXJyYXk8c3RyaW5nIHwgbnVtYmVyPiB8IHN0cmluZyk6IEV4dGVuZGVkQ29udHJvbHMge1xyXG4gICAgcmV0dXJuIHN1cGVyLmdldChwYXRoKSBhcyBhbnk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgcGF0Y2hWYWx1ZSh2YWx1ZTogeyBba2V5OiBzdHJpbmddOiBhbnkgfSwgb3B0aW9uczogeyBvbmx5U2VsZj86IGJvb2xlYW4sIGVtaXRFdmVudD86IGJvb2xlYW4sIHVzZUFzRGVmYXVsdD86IGJvb2xlYW4gfSA9IHt9KTogdm9pZCB7XHJcbiAgICBpZiAodmFsdWUgPT0gbnVsbCAvKiBib3RoIGBudWxsYCBhbmQgYHVuZGVmaW5lZGAgKi8pIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChvcHRpb25zLnVzZUFzRGVmYXVsdCkge1xyXG4gICAgICB0aGlzLmRlZmF1bHRWYWx1ZVBhdGNoZWQgPSB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIE9iamVjdC5rZXlzKHZhbHVlKS5mb3JFYWNoKG5hbWUgPT4ge1xyXG4gICAgICBpZiAodGhpcy5jb250cm9sc1tuYW1lXSkge1xyXG4gICAgICAgIHRoaXMuY29udHJvbHNbbmFtZV0ucGF0Y2hWYWx1ZSh2YWx1ZVtuYW1lXSwgeyAuLi5vcHRpb25zLCBvbmx5U2VsZjogdHJ1ZSB9KTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgdGhpcy51cGRhdGVWYWx1ZUFuZFZhbGlkaXR5KG9wdGlvbnMpO1xyXG5cclxuICAgIHRoaXMubGFzdFBhdGNoZWRWYWx1ZSA9IHZhbHVlO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHZhbGlkYXRlKHNjcm9sbFRvRXJyb3I6IGJvb2xlYW4gPSB0cnVlKTogYm9vbGVhbiB7XHJcbiAgICB0aGlzLm1hcmtBbGxBc1RvdWNoZWQoKTtcclxuICAgIHRoaXMudXBkYXRlVmFsdWVBbmRWYWxpZGl0eSh7IG9ubHlTZWxmOiB0cnVlIH0pO1xyXG5cclxuICAgIGlmIChzY3JvbGxUb0Vycm9yICYmIHRoaXMuaW52YWxpZCkge1xyXG4gICAgICB0aGlzLnNjcm9sbFRvRXJyb3IoKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdGhpcy52YWxpZDtcclxuICB9XHJcblxyXG4gIHB1YmxpYyByZXNldERlZmF1bHRWYWx1ZSgpOiB2b2lkIHtcclxuICAgIHRoaXMuZGVmYXVsdFZhbHVlUGF0Y2hlZCA9IGZhbHNlO1xyXG4gICAgT2JqZWN0LnZhbHVlcyh0aGlzLmNvbnRyb2xzKS5mb3JFYWNoKGNvbnRyb2wgPT4gY29udHJvbC5yZXNldERlZmF1bHRWYWx1ZSgpKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyByZXNldFRvRGVmYXVsdFZhbHVlKG9wdGlvbnM6IHsgb25seVNlbGY/OiBib29sZWFuLCBlbWl0RXZlbnQ/OiBib29sZWFuIH0gPSB7fSk6IHZvaWQge1xyXG4gICAgT2JqZWN0LnZhbHVlcyh0aGlzLmNvbnRyb2xzKS5mb3JFYWNoKGNvbnRyb2wgPT4gY29udHJvbC5yZXNldFRvRGVmYXVsdFZhbHVlKHsgLi4ub3B0aW9ucywgb25seVNlbGY6IHRydWUgfSkpO1xyXG4gICAgdGhpcy51cGRhdGVWYWx1ZUFuZFZhbGlkaXR5KCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc2Nyb2xsVG9FcnJvcigpOiB2b2lkIHtcclxuICAgIGNvbnN0IGludmFsaWRDb250cm9sID0gQ29tbW9uSGVscGVyLmdldEZpcnN0SW52YWxpZENvbnRyb2wodGhpcyk7XHJcbiAgICBpZiAoaW52YWxpZENvbnRyb2wpIHtcclxuICAgICAgaW52YWxpZENvbnRyb2wuaHRtbEluc3RhbmNlLnNjcm9sbEludG9WaWV3KHsgYmVoYXZpb3I6ICdzbW9vdGgnIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIHVwZGF0ZUNoaWxkcmVuQ29udHJvbHMoKTogdm9pZCB7XHJcbiAgICB0aGlzLmNoaWxkcmVuQ29udHJvbHMgPSBPYmplY3QudmFsdWVzKHRoaXMuY29udHJvbHMpO1xyXG5cclxuICAgIHRoaXMuY2hpbGRyZW5Db250cm9scy5zb3J0KChhOiBhbnksIGI6IGFueSkgPT4ge1xyXG4gICAgICBpZiAoYS5maWVsZENvbmZpZy5pbnRlcm5hbE9yZGVyIDwgYi5maWVsZENvbmZpZy5pbnRlcm5hbE9yZGVyKSB7XHJcbiAgICAgICAgcmV0dXJuIC0xO1xyXG4gICAgICB9IGVsc2UgaWYgKGEuZmllbGRDb25maWcuaW50ZXJuYWxPcmRlciA+IGIuZmllbGRDb25maWcuaW50ZXJuYWxPcmRlcikge1xyXG4gICAgICAgIHJldHVybiAxO1xyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4gMDtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGdldENvbnRyb2wocGF0aDogc3RyaW5nW10pOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgY29uc3QgcGF0aFN0ciA9IHRoaXMucGF0aEZyb21Sb290ICsgcGF0aC5qb2luKCcuJyk7XHJcbiAgICBjb25zdCByb290ID0gdGhpcy5yb290IGFzIEV4dGVuZGVkRm9ybUdyb3VwO1xyXG5cclxuICAgIGlmICghcm9vdC5zdXBwb3NlQ29udHJvbHMuaGFzKHBhdGhTdHIpKSB7XHJcbiAgICAgIHJvb3Quc3VwcG9zZUNvbnRyb2xzLnNldChwYXRoU3RyLCBuZXcgU3ViamVjdCgpKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBzdWJqZWN0ID0gcm9vdC5zdXBwb3NlQ29udHJvbHMuZ2V0KHBhdGhTdHIpIGFzIFN1YmplY3Q8YW55PjtcclxuICAgIHJldHVybiBzdWJqZWN0LnBpcGUoXHJcbiAgICAgIGZpbHRlcih2ID0+ICEhdilcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0UmF3VmFsdWUocGFyYW1zID0geyBpZ25vcmVkRmllbGRzOiBmYWxzZSB9KTogYW55IHtcclxuICAgIHJldHVybiB0aGlzLmNoaWxkcmVuQ29udHJvbHMucmVkdWNlKChhY2MsIGNvbnRyb2wpID0+IHtcclxuICAgICAgaWYgKCFjb250cm9sLmZpZWxkQ29uZmlnLmlnbm9yZSB8fCBwYXJhbXMuaWdub3JlZEZpZWxkcykge1xyXG4gICAgICAgIChhY2MgYXMgYW55KVtjb250cm9sLmZpZWxkQ29uZmlnLmtleV0gPSAoY29udHJvbCBhcyBhbnkpLmdldFJhd1ZhbHVlKHBhcmFtcyk7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIGFjYztcclxuICAgIH0sIHt9KSBhcyBhbnk7XHJcbiAgfVxyXG59Il19