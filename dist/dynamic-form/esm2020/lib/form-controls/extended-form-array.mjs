import { FormArray } from '@angular/forms';
import { map, startWith } from 'rxjs/operators';
import { CommonHelper, RandomHelper } from '../helpers';
export class ExtendedFormArray extends FormArray {
    constructor(formGroupFabric, validatorOrOpts, asyncValidator) {
        super([], validatorOrOpts, asyncValidator);
        this.formGroupFabric = formGroupFabric;
        this.id = RandomHelper.NumId;
        this.canAddRow = true;
        this.defaultValuePatched = false;
        this.error = this.statusChanges.pipe(startWith(false), map(() => CommonHelper.instantError(this, true)));
        this.errorObject = this.statusChanges.pipe(startWith(false), map(() => CommonHelper.instantError(this, false)));
    }
    get childrenControls() {
        return this.controls;
    }
    ;
    get(path) {
        return super.get(path);
    }
    get canShowError() {
        return this.invalid && (this.touched || this.dirty);
    }
    get isChangedByUser() {
        if (this.fieldConfig && typeof this.fieldConfig.checkChanges === 'function') {
            return this.fieldConfig.checkChanges(this.value, this.defaultValuePatched);
        }
        return this.controls.some(control => control.isChangedByUser);
    }
    patchValue(value, options = {}) {
        if (!Array.isArray(value)) {
            return;
        }
        if (options.useAsDefault) {
            this.defaultValuePatched = true;
        }
        this.removeAllControls();
        for (let i = this.controls.length; i < value.length; i++) {
            this.addControl(value[i]);
        }
        value.forEach(((newValue, index) => {
            if (this.at(index)) {
                this.at(index).patchValue(newValue, { ...options, onlySelf: true });
            }
        }));
        this.updateValueAndValidity(options);
        this.lastPatchedValue = value;
    }
    validate(scrollToError = false) {
        this.markAllAsTouched();
        this.updateValueAndValidity({ onlySelf: true });
        if (scrollToError && this.invalid) {
            this.scrollToError();
        }
        return this.valid;
    }
    scrollToError() {
        const invalidControl = CommonHelper.getFirstInvalidControl(this);
        if (invalidControl) {
            invalidControl.htmlInstance.scrollIntoView({ behavior: 'smooth' });
        }
    }
    resetDefaultValue() {
        this.defaultValuePatched = false;
        this.controls.forEach(control => control.resetDefaultValue());
    }
    resetToDefaultValue(options = {}) {
        if (!this.defaultValuePatched) {
            return;
        }
        if (Array.isArray(this.lastPatchedValue)) {
            this.removeAllControls();
            for (let i = this.controls.length; i < this.lastPatchedValue.length; i++) {
                this.addControl(this.lastPatchedValue[i]);
            }
            this.controls.forEach((control, index) => {
                control.patchValue(this.lastPatchedValue[index], { onlySelf: true, useAsDefault: true, ...options });
            });
            this.updateValueAndValidity({ onlySelf: true });
        }
    }
    updateChildrenControls() { }
    addControl(value) {
        const control = this.formGroupFabric(value);
        if (!control) {
            return;
        }
        if (this.disabled) {
            control.disable({ emitEvent: false });
        }
        this.push(control);
        return control;
    }
    removeControl(index) {
        this.removeAt(index);
    }
    enableAllControlByKey(key) {
        // @ts-ignore
        this.controls.forEach(control => control.get(key).enable());
    }
    removeAllControls() {
        while (this.controls.length !== 0) {
            this.removeAt(0);
        }
    }
    getRawValue(params = { ignoredFields: false }) {
        return this.childrenControls.reduce((acc, control) => {
            if (!control.fieldConfig.ignore || params.ignoredFields) {
                acc.push(control.getRawValue(params));
            }
            return acc;
        }, []);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXh0ZW5kZWQtZm9ybS1hcnJheS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2R5bmFtaWMtZm9ybS9zcmMvbGliL2Zvcm0tY29udHJvbHMvZXh0ZW5kZWQtZm9ybS1hcnJheS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQTRDLFNBQVMsRUFBZSxNQUFNLGdCQUFnQixDQUFDO0FBRWxHLE9BQU8sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFaEQsT0FBTyxFQUFFLFlBQVksRUFBRSxZQUFZLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFLeEQsTUFBTSxPQUFPLGlCQUFrQixTQUFRLFNBQVM7SUFzQjlDLFlBQW1CLGVBQWtELEVBQ3pELGVBQTZFLEVBQzdFLGNBQTZEO1FBRXZFLEtBQUssQ0FBQyxFQUFFLEVBQUUsZUFBZSxFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBSjFCLG9CQUFlLEdBQWYsZUFBZSxDQUFtQztRQXJCckQsT0FBRSxHQUFHLFlBQVksQ0FBQyxLQUFLLENBQUM7UUFPakMsY0FBUyxHQUE4QixJQUFJLENBQUM7UUFDNUMsd0JBQW1CLEdBQUcsS0FBSyxDQUFDO1FBRzVCLFVBQUssR0FBOEIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQy9ELFNBQVMsQ0FBQyxLQUFLLENBQUMsRUFDaEIsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQ2pELENBQUM7UUFFSyxnQkFBVyxHQUFtQyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FDMUUsU0FBUyxDQUFDLEtBQUssQ0FBQyxFQUNoQixHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FDbEQsQ0FBQztJQU9GLENBQUM7SUFFRCxJ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QUN2QztRQUVELElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDbkIsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQztJQUVNLGFBQWEsQ0FBQyxLQUFhO1FBQ2hDLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUE7SUFDdEIsQ0FBQztJQUVNLHFCQUFxQixDQUFDLEdBQVc7UUFDdEMsYUFBYTtRQUNiLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO0lBQzlELENBQUM7SUFFTSxpQkFBaUI7UUFDdEIsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDakMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNsQjtJQUNILENBQUM7SUFFTSxXQUFXLENBQUMsTUFBTSxHQUFHLEVBQUUsYUFBYSxFQUFFLEtBQUssRUFBRTtRQUNsRCxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEVBQUUsT0FBTyxFQUFFLEVBQUU7WUFDbkQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsTUFBTSxJQUFJLE1BQU0sQ0FBQyxhQUFhLEVBQUU7Z0JBQ3ZELEdBQUcsQ0FBQyxJQUFJLENBQUUsT0FBZSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO2FBQ2hEO1lBQ0QsT0FBTyxHQUFHLENBQUM7UUFDYixDQUFDLEVBQUUsRUFBRSxDQUFRLENBQUM7SUFDaEIsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWJzdHJhY3RDb250cm9sT3B0aW9ucywgQXN5bmNWYWxpZGF0b3JGbiwgRm9ybUFycmF5LCBWYWxpZGF0b3JGbiB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBtYXAsIHN0YXJ0V2l0aCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgQXJyYXlGaWVsZCB9IGZyb20gJy4uL2Jhc2UuZmllbGQnO1xyXG5pbXBvcnQgeyBDb21tb25IZWxwZXIsIFJhbmRvbUhlbHBlciB9IGZyb20gJy4uL2hlbHBlcnMnO1xyXG5pbXBvcnQgeyBFcnJvck9iamVjdCB9IGZyb20gJy4uL2ludGVyZmFjZXMnO1xyXG5cclxuaW1wb3J0IHsgRXh0ZW5kZWRDb250cm9scywgRXh0ZW5kZWRGb3JtQ29udHJvbCwgRXh0ZW5kZWRGb3JtR3JvdXAgfSBmcm9tICcuL2luZGV4JztcclxuXHJcbmV4cG9ydCBjbGFzcyBFeHRlbmRlZEZvcm1BcnJheSBleHRlbmRzIEZvcm1BcnJheSB7XHJcbiAgcHVibGljIHJlYWRvbmx5IGlkID0gUmFuZG9tSGVscGVyLk51bUlkO1xyXG5cclxuICBwcml2YXRlIGxhc3RQYXRjaGVkVmFsdWU6IGFueTtcclxuXHJcbiAgcHVibGljIHBhdGhGcm9tUm9vdCE6IHN0cmluZztcclxuICBwdWJsaWMgb3ZlcnJpZGUgY29udHJvbHMhOiBBcnJheTxFeHRlbmRlZEZvcm1Hcm91cD47XHJcbiAgcHVibGljIGZpZWxkQ29uZmlnITogQXJyYXlGaWVsZDtcclxuICBwdWJsaWMgY2FuQWRkUm93OiAoKCkgPT4gYm9vbGVhbikgfCBib29sZWFuID0gdHJ1ZTtcclxuICBwdWJsaWMgZGVmYXVsdFZhbHVlUGF0Y2hlZCA9IGZhbHNlO1xyXG4gIHB1YmxpYyBodG1sSW5zdGFuY2UhOiBIVE1MRWxlbWVudDtcclxuXHJcbiAgcHVibGljIGVycm9yOiBPYnNlcnZhYmxlPHN0cmluZyB8IG51bGw+ID0gdGhpcy5zdGF0dXNDaGFuZ2VzLnBpcGUoXHJcbiAgICBzdGFydFdpdGgoZmFsc2UpLFxyXG4gICAgbWFwKCgpID0+IENvbW1vbkhlbHBlci5pbnN0YW50RXJyb3IodGhpcywgdHJ1ZSkpXHJcbiAgKTtcclxuXHJcbiAgcHVibGljIGVycm9yT2JqZWN0OiBPYnNlcnZhYmxlPEVycm9yT2JqZWN0IHwgbnVsbD4gPSB0aGlzLnN0YXR1c0NoYW5nZXMucGlwZShcclxuICAgIHN0YXJ0V2l0aChmYWxzZSksXHJcbiAgICBtYXAoKCkgPT4gQ29tbW9uSGVscGVyLmluc3RhbnRFcnJvcih0aGlzLCBmYWxzZSkpXHJcbiAgKTtcclxuXHJcbiAgY29uc3RydWN0b3IocHVibGljIGZvcm1Hcm91cEZhYnJpYzogKHZhbHVlPzogYW55KSA9PiBFeHRlbmRlZENvbnRyb2xzLFxyXG4gICAgICAgICAgICAgIHZhbGlkYXRvck9yT3B0cz86IFZhbGlkYXRvckZuIHwgVmFsaWRhdG9yRm5bXSB8IEFic3RyYWN0Q29udHJvbE9wdGlvbnMgfCBudWxsLFxyXG4gICAgICAgICAgICAgIGFzeW5jVmFsaWRhdG9yPzogQXN5bmNWYWxpZGF0b3JGbiB8IEFzeW5jVmFsaWRhdG9yRm5bXSB8IG51bGwsXHJcbiAgKSB7XHJcbiAgICBzdXBlcihbXSwgdmFsaWRhdG9yT3JPcHRzLCBhc3luY1ZhbGlkYXRvcik7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0IGNoaWxkcmVuQ29udHJvbHMoKTogQXJyYXk8RXh0ZW5kZWRGb3JtR3JvdXA+IHtcclxuICAgIHJldHVybiB0aGlzLmNvbnRyb2xzXHJcbiAgfTtcclxuXHJcbiAgcHVibGljIGdldChwYXRoOiBBcnJheTxzdHJpbmcgfCBudW1iZXI+IHwgc3RyaW5nKTogRXh0ZW5kZWRGb3JtQ29udHJvbCB7XHJcbiAgICByZXR1cm4gc3VwZXIuZ2V0KHBhdGgpIGFzIEV4dGVuZGVkRm9ybUNvbnRyb2w7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0IGNhblNob3dFcnJvcigpOiBib29sZWFuIHtcclxuICAgIHJldHVybiB0aGlzLmludmFsaWQgJiYgKHRoaXMudG91Y2hlZCB8fCB0aGlzLmRpcnR5KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBnZXQgaXNDaGFuZ2VkQnlVc2VyKCk6IGJvb2xlYW4ge1xyXG4gICAgaWYgKHRoaXMuZmllbGRDb25maWcgJiYgdHlwZW9mIHRoaXMuZmllbGRDb25maWcuY2hlY2tDaGFuZ2VzID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmZpZWxkQ29uZmlnLmNoZWNrQ2hhbmdlcyh0aGlzLnZhbHVlLCB0aGlzLmRlZmF1bHRWYWx1ZVBhdGNoZWQpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB0aGlzLmNvbnRyb2xzLnNvbWUoY29udHJvbCA9PiBjb250cm9sLmlzQ2hhbmdlZEJ5VXNlcik7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgcGF0Y2hWYWx1ZSh2YWx1ZTogeyBba2V5OiBzdHJpbmddOiBhbnkgfVtdLCBvcHRpb25zOiB7IG9ubHlTZWxmPzogYm9vbGVhbiwgZW1pdEV2ZW50PzogYm9vbGVhbiwgdXNlQXNEZWZhdWx0PzogYm9vbGVhbiB9ID0ge30pOiB2b2lkIHtcclxuICAgIGlmICghQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChvcHRpb25zLnVzZUFzRGVmYXVsdCkge1xyXG4gICAgICB0aGlzLmRlZmF1bHRWYWx1ZVBhdGNoZWQgPSB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMucmVtb3ZlQWxsQ29udHJvbHMoKVxyXG5cclxuICAgIGZvciAobGV0IGkgPSB0aGlzLmNvbnRyb2xzLmxlbmd0aDsgaSA8IHZhbHVlLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgIHRoaXMuYWRkQ29udHJvbCh2YWx1ZVtpXSk7XHJcbiAgICB9XHJcblxyXG4gICAgdmFsdWUuZm9yRWFjaCgoKG5ld1ZhbHVlLCBpbmRleCkgPT4ge1xyXG4gICAgICBpZiAodGhpcy5hdChpbmRleCkpIHtcclxuICAgICAgICB0aGlzLmF0KGluZGV4KS5wYXRjaFZhbHVlKG5ld1ZhbHVlLCB7IC4uLm9wdGlvbnMsIG9ubHlTZWxmOiB0cnVlIH0pO1xyXG4gICAgICB9XHJcbiAgICB9KSk7XHJcblxyXG4gICAgdGhpcy51cGRhdGVWYWx1ZUFuZFZhbGlkaXR5KG9wdGlvbnMpO1xyXG5cclxuICAgIHRoaXMubGFzdFBhdGNoZWRWYWx1ZSA9IHZhbHVlO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHZhbGlkYXRlKHNjcm9sbFRvRXJyb3I6IGJvb2xlYW4gPSBmYWxzZSk6IGJvb2xlYW4ge1xyXG4gICAgdGhpcy5tYXJrQWxsQXNUb3VjaGVkKCk7XHJcbiAgICB0aGlzLnVwZGF0ZVZhbHVlQW5kVmFsaWRpdHkoeyBvbmx5U2VsZjogdHJ1ZSB9KTtcclxuXHJcbiAgICBpZiAoc2Nyb2xsVG9FcnJvciAmJiB0aGlzLmludmFsaWQpIHtcclxuICAgICAgdGhpcy5zY3JvbGxUb0Vycm9yKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRoaXMudmFsaWQ7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc2Nyb2xsVG9FcnJvcigpOiB2b2lkIHtcclxuICAgIGNvbnN0IGludmFsaWRDb250cm9sID0gQ29tbW9uSGVscGVyLmdldEZpcnN0SW52YWxpZENvbnRyb2wodGhpcyk7XHJcbiAgICBpZiAoaW52YWxpZENvbnRyb2wpIHtcclxuICAgICAgaW52YWxpZENvbnRyb2wuaHRtbEluc3RhbmNlLnNjcm9sbEludG9WaWV3KHsgYmVoYXZpb3I6ICdzbW9vdGgnIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIHJlc2V0RGVmYXVsdFZhbHVlKCk6IHZvaWQge1xyXG4gICAgdGhpcy5kZWZhdWx0VmFsdWVQYXRjaGVkID0gZmFsc2U7XHJcbiAgICB0aGlzLmNvbnRyb2xzLmZvckVhY2goY29udHJvbCA9PiBjb250cm9sLnJlc2V0RGVmYXVsdFZhbHVlKCkpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHJlc2V0VG9EZWZhdWx0VmFsdWUob3B0aW9uczogeyBvbmx5U2VsZj86IGJvb2xlYW4sIGVtaXRFdmVudD86IGJvb2xlYW4sIHVzZUFzRGVmYXVsdD86IGJvb2xlYW4gfSA9IHt9KTogdm9pZCB7XHJcbiAgICBpZiAoIXRoaXMuZGVmYXVsdFZhbHVlUGF0Y2hlZCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKEFycmF5LmlzQXJyYXkodGhpcy5sYXN0UGF0Y2hlZFZhbHVlKSkge1xyXG4gICAgICB0aGlzLnJlbW92ZUFsbENvbnRyb2xzKClcclxuXHJcbiAgICAgIGZvciAobGV0IGkgPSB0aGlzLmNvbnRyb2xzLmxlbmd0aDsgaSA8IHRoaXMubGFzdFBhdGNoZWRWYWx1ZS5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgIHRoaXMuYWRkQ29udHJvbCh0aGlzLmxhc3RQYXRjaGVkVmFsdWVbaV0pO1xyXG4gICAgICB9XHJcblxyXG4gICAgICB0aGlzLmNvbnRyb2xzLmZvckVhY2goKGNvbnRyb2wsIGluZGV4KSA9PiB7XHJcbiAgICAgICAgY29udHJvbC5wYXRjaFZhbHVlKHRoaXMubGFzdFBhdGNoZWRWYWx1ZVtpbmRleF0sIHsgb25seVNlbGY6IHRydWUsIHVzZUFzRGVmYXVsdDogdHJ1ZSwgLi4ub3B0aW9ucyB9KVxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIHRoaXMudXBkYXRlVmFsdWVBbmRWYWxpZGl0eSh7IG9ubHlTZWxmOiB0cnVlIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIHVwZGF0ZUNoaWxkcmVuQ29udHJvbHMoKTogdm9pZCB7fVxyXG5cclxuICBwdWJsaWMgYWRkQ29udHJvbCh2YWx1ZT86IGFueSk6IGFueSB7XHJcbiAgICBjb25zdCBjb250cm9sID0gdGhpcy5mb3JtR3JvdXBGYWJyaWModmFsdWUpO1xyXG5cclxuICAgIGlmICghY29udHJvbCkge1xyXG4gICAgICByZXR1cm5cclxuICAgIH1cclxuXHJcbiAgICBpZiAodGhpcy5kaXNhYmxlZCkge1xyXG4gICAgICBjb250cm9sLmRpc2FibGUoeyBlbWl0RXZlbnQ6IGZhbHNlIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMucHVzaChjb250cm9sKTtcclxuICAgIHJldHVybiBjb250cm9sO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHJlbW92ZUNvbnRyb2woaW5kZXg6IG51bWJlcik6IHZvaWQge1xyXG4gICAgdGhpcy5yZW1vdmVBdChpbmRleClcclxuICB9XHJcblxyXG4gIHB1YmxpYyBlbmFibGVBbGxDb250cm9sQnlLZXkoa2V5OiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIC8vIEB0cy1pZ25vcmVcclxuICAgIHRoaXMuY29udHJvbHMuZm9yRWFjaChjb250cm9sID0+IGNvbnRyb2wuZ2V0KGtleSkuZW5hYmxlKCkpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHJlbW92ZUFsbENvbnRyb2xzKCk6IHZvaWQge1xyXG4gICAgd2hpbGUgKHRoaXMuY29udHJvbHMubGVuZ3RoICE9PSAwKSB7XHJcbiAgICAgIHRoaXMucmVtb3ZlQXQoMCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0UmF3VmFsdWUocGFyYW1zID0geyBpZ25vcmVkRmllbGRzOiBmYWxzZSB9KTogYW55IHtcclxuICAgIHJldHVybiB0aGlzLmNoaWxkcmVuQ29udHJvbHMucmVkdWNlKChhY2MsIGNvbnRyb2wpID0+IHtcclxuICAgICAgaWYgKCFjb250cm9sLmZpZWxkQ29uZmlnLmlnbm9yZSB8fCBwYXJhbXMuaWdub3JlZEZpZWxkcykge1xyXG4gICAgICAgIGFjYy5wdXNoKChjb250cm9sIGFzIGFueSkuZ2V0UmF3VmFsdWUocGFyYW1zKSk7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIGFjYztcclxuICAgIH0sIFtdKSBhcyBhbnk7XHJcbiAgfVxyXG59XHJcbiJdfQ==