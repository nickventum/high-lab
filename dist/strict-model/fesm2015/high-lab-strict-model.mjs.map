{"version":3,"file":"high-lab-strict-model.mjs","sources":["../../../projects/strict-model/src/lib/strict-model.ts","../../../projects/strict-model/src/public-api.ts","../../../projects/strict-model/src/high-lab-strict-model.ts"],"sourcesContent":["import isEqual from 'lodash-es/isEqual';\r\nimport { Observable, Subject } from 'rxjs';\r\nimport { debounceTime, distinctUntilChanged } from 'rxjs/operators';\r\n\r\nconst USE_DEFAULT = Symbol('useDefault');\r\n\r\ntype AnyClass = new (...args: any[]) => any;\r\ntype AnyArrayClass = new (...args: any[]) => Array<any>;\r\n\r\nfunction convertValueToType(value: any, useDefault: boolean, type: any, arrayLike?: AnyArrayClass): boolean | string | number | Date {\r\n\tif (arrayLike) {\r\n\t\tif (Array.isArray(value)) {\r\n\t\t\treturn Reflect.construct(arrayLike, value.map(v => convertValueToType(v, useDefault, type)));\r\n\t\t} else {\r\n\t\t\treturn Reflect.construct(arrayLike, []);\r\n\t\t}\r\n\t}\r\n\r\n\tswitch (type) {\r\n\t\tcase Boolean: {\r\n\t\t\treturn typeof value === 'string' ? value === 'true' || value === '1' : !!value;\r\n\t\t}\r\n\t\tcase Number: {\r\n\t\t\treturn value === null ? 0 : typeof value === 'string' ? parseFloat(value) : value;\r\n\t\t}\r\n\t\tcase String: {\r\n\t\t\treturn value ? `${value}` : '';\r\n\t\t}\r\n\t\tcase Date: {\r\n\t\t\treturn value instanceof Date ? value : value ? new Date(value) : value;\r\n\t\t}\r\n\t\tcase Object: {\r\n\t\t\tif (typeof value === 'object') {\r\n\t\t\t\treturn useDefault ? Object.assign({}, value) : value;\r\n\t\t\t}\r\n\r\n\t\t\treturn {} as any;\r\n\t\t}\r\n\t\tdefault: {\r\n\t\t\tif (type.prototype) {\r\n\t\t\t\treturn Reflect.construct(type, [value]);\r\n\t\t\t} else {\r\n\t\t\t\treturn value;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport function StrictProperty(type: AnyClass, defaultValue?: any, jsonKey?: string): PropertyDecorator;\r\nexport function StrictProperty(type: AnyArrayClass, subType: AnyClass, defaultValue?: any, jsonKey?: string): PropertyDecorator;\r\nexport function StrictProperty(type: AnyClass | AnyArrayClass, subType?: any, defaultValue?: any, jsonKey?: string): PropertyDecorator {\r\n\tconst isArrayLike = subType instanceof Function;\r\n\r\n\tif (subType !== undefined && !isArrayLike) {\r\n\t\tjsonKey = defaultValue;\r\n\t\tdefaultValue = subType;\r\n\t}\r\n\r\n\treturn (target: any, propertyKey: string) => {\r\n\t\tconst secret = Symbol(propertyKey);\r\n\r\n\t\tif (!target.__properties) {\r\n\t\t\ttarget.__properties = {};\r\n\t\t}\r\n\r\n\t\tif (!target.__jsonKeys) {\r\n\t\t\ttarget.__jsonKeys = {};\r\n\t\t}\r\n\r\n\t\tif (!target.__propertyKeys) {\r\n\t\t\ttarget.__propertyKeys = {};\r\n\t\t}\r\n\r\n\t\ttarget.__properties[propertyKey] = 1;\r\n\r\n\t\tif (jsonKey) {\r\n\t\t\ttarget.__jsonKeys[jsonKey] = propertyKey;\r\n\t\t\ttarget.__propertyKeys[propertyKey] = jsonKey;\r\n\t\t}\r\n\r\n\r\n\t\tObject.defineProperty(target, propertyKey, {\r\n\t\t\tget() {\r\n\t\t\t\treturn this[secret];\r\n\t\t\t},\r\n\t\t\tset(value: any) {\r\n\t\t\t\tconst useDefault = value === USE_DEFAULT;\r\n\r\n\t\t\t\tif (useDefault) {\r\n\t\t\t\t\tvalue = defaultValue;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst normalizedValue: any = isArrayLike ?\r\n\t\t\t\t\tconvertValueToType(value, useDefault, subType, type) :\r\n\t\t\t\t\tconvertValueToType(value, useDefault, type);\r\n\r\n\t\t\t\tif (\r\n\t\t\t\t\tnormalizedValue !== null &&\r\n\t\t\t\t\ttypeof normalizedValue === 'object' &&\r\n\t\t\t\t\tReflect.has(normalizedValue, 'parent') &&\r\n\t\t\t\t\t!normalizedValue.parent\r\n\t\t\t\t) {\r\n\t\t\t\t\tnormalizedValue.parent = this;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tthis[secret] = normalizedValue;\r\n\r\n\t\t\t\tthis.nextChange({ key: propertyKey, value: this[secret] });\r\n\t\t\t},\r\n\t\t});\r\n\t};\r\n}\r\n\r\n\r\nexport class StrictModel {\r\n\tprotected changeSub: Subject<any> = new Subject();\r\n\tprotected parent: StrictModel | undefined = undefined;\r\n\r\n\tconstructor(options?: any,\r\n\t\t\t\tmakeSnapshot: boolean = true,\r\n\t) {\r\n\t\t// @ts-ignore\r\n\t\tconst propertyKeys = this.__propertyKeys;\r\n\t\t// @ts-ignore\r\n\t\tObject.keys(this.__properties || {}).forEach(key => {\r\n\t\t\tconst propertyKey = propertyKeys[key] || key;\r\n\r\n\t\t\tif (options && options.hasOwnProperty(propertyKey)) {\r\n\t\t\t\tthis[key] = options[propertyKey];\r\n\t\t\t} else {\r\n\t\t\t\tthis[key] = USE_DEFAULT;\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tif (makeSnapshot) {\r\n\t\t\t// @ts-ignore\r\n\t\t\tthis.__defaultSnapshot = this.getNewInstance(false);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic update(params: any): void {\r\n\t\tObject.assign(this, params);\r\n\t}\r\n\r\n\tpublic reset(): void {\r\n\t\t// @ts-ignore\r\n\t\tthis.update(this.__defaultSnapshot.toJSON());\r\n\t}\r\n\r\n\tpublic isDefault(): boolean {\r\n\t\t// @ts-ignore\r\n\t\treturn !Object.keys(this.__properties || {}).some(key => {\r\n\t\t\tconst value = this[key];\r\n\r\n\t\t\tif (value && typeof value.isDefault === 'function') {\r\n\t\t\t\treturn !value.isDefault();\r\n\t\t\t} else if (value && typeof value === 'object') {\r\n\t\t\t\t// @ts-ignore\r\n\t\t\t\treturn !isEqual(value, this.__defaultSnapshot[key]);\r\n\t\t\t}\r\n\t\t\t// @ts-ignore\r\n\t\t\treturn value !== this.__defaultSnapshot[key];\r\n\t\t});\r\n\t}\r\n\r\n\tpublic toJSON(): any {\r\n\t\t// @ts-ignore\r\n\t\treturn this.assignProperties({}, this.__properties);\r\n\t}\r\n\r\n\tpublic get change(): Observable<any> {\r\n\t\tif (this.parent) {\r\n\t\t\treturn this.parent.change;\r\n\t\t}\r\n\r\n\t\treturn this.changeSub.asObservable().pipe(\r\n\t\t\tdebounceTime(50),\r\n\t\t\tdistinctUntilChanged()\r\n\t\t);\r\n\t}\r\n\r\n\tprotected nextChange(value: any): void {\r\n\t\tif (this.parent) {\r\n\t\t\treturn this.parent.nextChange(value);\r\n\t\t}\r\n\r\n\t\treturn this.changeSub.next(value);\r\n\t}\r\n\r\n\tprotected getNewInstance(makeSnapshot: boolean): any {\r\n\t\treturn Reflect.construct(this.constructor, [{}, makeSnapshot]);\r\n\t}\r\n\r\n\tprotected assignProperties(target, source): any {\r\n\t\t// @ts-ignore\r\n\t\tconst propertyKeys = this.__propertyKeys;\r\n\r\n\t\treturn [...Object.keys(source)].reduce((acc, key) => {\r\n\t\t\tconst originalKey = propertyKeys[key] || key;\r\n\r\n\t\t\tif (key !== '__properties' && key !== '__jsonKeys') {\r\n\t\t\t\tif (this[key] && this[key].toJSON) {\r\n\t\t\t\t\tacc[originalKey] = this[key].toJSON();\r\n\t\t\t\t} else if (typeof this[key] === 'object') {\r\n\t\t\t\t\tacc[originalKey] = JSON.parse(JSON.stringify(this[key]));\r\n\t\t\t\t} else {\r\n\t\t\t\t\tacc[originalKey] = this[key];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\treturn acc;\r\n\t\t}, target);\r\n\t}\r\n}\r\n","/*\r\n * Public API Surface of strict-model\r\n */\r\n\r\nexport * from './lib/strict-model';\r\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public-api';\n"],"names":[],"mappings":"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"}